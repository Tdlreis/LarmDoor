{% extends 'base.html' %}
{% block content %}
<style>
    .hidden
    {
        display: none;
    }

    select option:selected {
        display: none;
      }

    body {
        background-color: #f8f9fa;
        height: auto;
    }

    .form-container {
        background-color: #fff;
        border-radius: 10px;
        padding: 40px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }

    .form-title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
    }

    .form-group label {
        font-weight: bold;
        color: #555;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group select {
        border: none;
        border-radius: 5px;
        background-color: #f8f9fa;
        padding: 10px;
        width: 100%;
        margin-top: 5px;
        margin-bottom: 20px;
        font-size: 16px;
        color: #333;
        transition: background-color 0.3s ease;
    }

    .form-group input[type="text"]:focus,
    .form-group select:focus {
        outline: none;
        background-color: #e2e6ea;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        font-size: 16px;
    }

    .btn-primary:hover {
        background-color: #0069d9;
        border-color: #0062cc;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        font-size: 16px;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }

    .form-group.autorizacao-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .form-group.autorizacao-container label {
        margin: 0;
        margin-right: 10px;
    }

    .form-group.ano-container {
        -webkit-appearance: none;
        appearance: none;
    }

    .rfid-form {
        padding: 0.5vh;
        width: 100%;
    }

    .rfid-form input[type="text"],
    .rfid-form select {
        border: none;
        border-radius: 5px;
        background-color: #f8f9fa;
        padding: 10px;
        width: 90%;
        margin-top: 5px;
        margin-bottom: 20px;
        margin-right: 20px;
        font-size: 16px;
        color: #333;
        transition: background-color 0.3s ease;
    }

    .rfid-form input[type="text"]:focus,
    .rfid-form select:focus {
        outline: none;
        background-color: #e2e6ea;
    }

    .btn-terciary {
        width: 100%;
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
        font-size: 16px;
        margin-bottom: 10px;
    }

    .btn-terciary:hover {
        background-color: #0069d9;
        border-color: #0062cc;
    }

    #student-form {
        background-color: #eef1f3;
        padding: 20px;
        border-radius: 10%;
    }

</style>
<body>
    <p> {{ message }} </p>
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-6 form-container">
                <h1 class="form-title">Cadastro</h1>
                <form name="form" id="form" action="." method="POST">
                    {% csrf_token %}
                    <div class="form-group">
                        {% if username != None %}
                            <p> {{ username.0 }} </p>
                        {% endif %}
                        <label for="username">Nome:</label>
                        {{form.username}}
                    </div>
                    <div class="form-group">
                        {% if email != None %}
                            <p> {{ email.0 }} </p>
                        {% endif %}
                        <label for="email">E-Mail:</label>                        
                        {{form.email}}
                    </div>
                    <div class="form-group">
                        {% if password != None %}
                            <p> {{ password.0 }} </p>
                        {% endif %}
                        <label for="password">Password:</label>                        
                        {{form.password}}
                    </div>
                    <div class="form-group">
                        {% if user_type != None %}
                            <p> {{ user_type.0 }} </p>
                        {% endif %}
                        <label for="user_type">Tipo de Usuário:</label>      
                        {{form.user_type}}
                    </div>
                    <div id='student-form' class="hidden"></div>
                    {% if formset %}
                    <h3>Rfid</h3>
                    {{ formset.management_form }}
                    <div id='rfid-form-list'>
                        {% for form in formset %}
                        <div class="rfid-form">
                            {{ form.as_table }}
                        </div>
                        {% endfor %}
                    </div>
                    <div id='empty-form' class='hidden'>{{formset.empty_form}}</div>
                    <button class="btn btn-terciary" id='add-more' type='button'>Adicionar Cartão</button>
                    {% endif %}                    
                    <div class="form-group autorizacao-container">
                        <label for="authorization">Autorização:</label>
                        {{form.authorization}}
                    </div>
                    <div class="text-center">
                        <button  class="btn btn-primary" type='submit' >Save</button>
                        <a href="/" class="btn btn-secondary ml-2">Voltar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const addMoreBtn = document.getElementById('add-more')
        const totalNewForms = document.getElementById('id_form-TOTAL_FORMS')
        
        addMoreBtn.addEventListener('click', add_new_form)

        function add_new_form(event) {
            if (event) {
                event.preventDefault()
            }
            var currentRfidForms = document.getElementsByClassName('rfid-form')
            var currentFormCount = currentRfidForms.length

            const formCopyTarget = document.getElementById('rfid-form-list')
            const copyEmptyFormEl = document.getElementById('empty-form').cloneNode(true)
            const lastAddedForm = currentRfidForms[currentFormCount - 1]
            const inputs = lastAddedForm.getElementsByTagName('input')

            if (inputs[0].value.trim() == '') {
                lastAddedForm.remove()                
                currentRfidForms = document.getElementsByClassName('rfid-form')
                currentFormCount = currentRfidForms.length
            }

            copyEmptyFormEl.setAttribute('class', 'rfid-form')
            copyEmptyFormEl.setAttribute('id', `form-${currentFormCount}`)
            const regex = new RegExp('__prefix__', 'g')
            copyEmptyFormEl.innerHTML = copyEmptyFormEl.innerHTML.replace(regex, currentFormCount)
            totalNewForms.setAttribute('value', currentFormCount + 1)

            fetch('/fetchrfid/')
            .then(response => {
                if (response.ok) {
                    return response.json()
                } else {
                // Request failed
                console.error('Request failed.')
                }
            }).then(data =>{
                const inputField = copyEmptyFormEl.querySelector('input')
                inputField.value = data.rfid
            }).catch(error => {
                // An error occurred during the request
                console.error('An error occurred:', error)
            })

            
            formCopyTarget.append(copyEmptyFormEl) 
        }

        $(document).ready(function(){
            var selected_option = $('#id_user_type').val();
            if (selected_option == 1) {
                $('#student-form').removeClass("hidden");
                $('#student-form').append("{% for fm in strudentForm %}<div class= \"form-group\"><label>{{fm.label}}</label><p>{{fm | escapejs}}</p></div>{% endfor %}");
            }

            $('#id_user_type').change(function(){
                selected_option = $('#id_user_type').val();
                if (selected_option == 1) {
                    $('#student-form').removeClass("hidden");
                    $('#student-form').append("{% for fm in strudentForm %}<div class= \"form-group\"><label>{{fm.label}}</label><p>{{fm | escapejs}}</p></div>{% endfor %}");
                } else {
                    $('#student-form').addClass("hidden");
                    $('#student-form').empty();
                }
            });
        })
    </script>
</body>
{% endblock %}
